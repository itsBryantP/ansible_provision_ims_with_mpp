- name: Provision Bank of Z
  hosts: zsystem
  gather_facts: false
  # * Include different variable files depending on environment/inventory used
  # ? Would it be better to use include_vars before including the role associated with the vars file?
  vars_files:
    - "{{ vars_folder_name }}/ims-dbdc.yml"
    - "{{ vars_folder_name }}/ims-jmp.yml"
    - "{{ vars_folder_name }}/zcee.yml"
    - "{{ vars_folder_name }}/bank.yml"
  environment: '{{ system_environment }}'
  tasks:
    - name: Create temporary directory to store provisioning files
      tempfile:
        state: directory
      register: provision_tmp_dir

    - block:

        - include_role: 
            name: install-bzip2

        - include_role: 
            name: install-mvs-utilities

        - include_role:
            name: provision-ims-dbdc
        
        # TODO: put each mpp type in separate roles
        - name: Load MPP2 specific variables
          include_vars: "{{ playbook_dir }}/{{ vars_folder_name }}/ims-mpp-2.yml"   

        - include_role:
            name: provision-mpp

        - include_role:
            name: provision-jmp

        # TODO: put each mpp type in separate roles
        - name: Load MPP1 specific variables
          include_vars: "{{ playbook_dir }}/{{ vars_folder_name }}/ims-mpp-1.yml"

        - include_role:
            name: provision-mpp

        - include_role:
            name: provision-zcee

        - include_role:
            name: configure-ims-bank
      always:
        - name: Delete the temporary provision files directory
          file:
            path: "{{ provision_tmp_dir.path }}"
            state: absent
      vars:
        uss_file_path: '{{ provision_tmp_dir.path }}'